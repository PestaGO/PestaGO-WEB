<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4CAF50">
    <title>{% block title %}PestaGO{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="icon" href="{% static 'img/icon.svg' %}">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/custom.css' %}">
    
    <style>
        /* Mobile-specific styles */
        body {
            overscroll-behavior: none; /* Prevent pull-to-refresh */
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
            touch-action: manipulation; /* Optimize for touch */
            padding-bottom: 60px; /* Space for mobile nav */
            background-color: #f8f9fa;
        }
        
        .mobile-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #6c757d;
            text-decoration: none;
            font-size: 0.8rem;
        }
        
        .mobile-nav-item.active {
            color: #4CAF50;
        }
        
        .mobile-nav-item i {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }
        
        /* Status colors */
        .healthy-color { color: #28a745; }
        .infected-color { color: #fd7e14; }
        .disease-color { color: #dc3545; }
        
        .status-healthy-bg {
            background-color: #d4edda;
            color: #155724;
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        .status-infected-bg {
            background-color: #f8d7da;
            color: #721c24;
            padding: 5px 10px;
            border-radius: 4px;
        }
        
        /* Animation for status */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
        
        .animate-pulse {
            animation: pulse 2s infinite;
        }
        
        /* Camera styles */
        .camera-area {
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        #camera-preview, #camera-canvas {
            border-radius: 8px;
            max-height: 50vh;
            object-fit: contain;
        }
        
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-area:hover {
            border-color: #4CAF50;
            background-color: #f8f9fa;
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #4CAF50;
            margin-bottom: 1rem;
        }
        
        /* Result image */
        .result-image {
            max-height: 50vh;
            object-fit: contain;
        }
        
        /* Logo styles */
        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 70vh;
        }
        
        .logo-img {
            width: 150px;
            height: auto;
            margin-bottom: 1.5rem;
            animation: pulse 3s infinite;
        }
        
        .header-icon {
            height: 40px;
            width: auto;
            vertical-align: middle;
        }
        
        .logo-text {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Toast container for notifications -->
    <div class="toast-container"></div>
    
    <!-- Main Content -->
    <main class="container py-4 page-transition">
        {% block content %}{% endblock %}
    </main>
    
    <!-- Mobile Bottom Navigation -->
    <div class="mobile-nav">
        <a href="{% url 'home' %}" id="gallery-btn" class="mobile-nav-item">
            <i class="fas fa-images"></i>
            <span>Gallery</span>
        </a>
        <a href="{% url 'home' %}#camera-section" id="camera-btn" class="mobile-nav-item">
            <i class="fas fa-camera"></i>
            <span>Camera</span>
        </a>
        <a href="{% url 'home' %}#about-section" id="about-btn" class="mobile-nav-item">
            <i class="fas fa-info-circle"></i>
            <span>About</span>
        </a>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Custom JS file -->
    <script src="{% static 'js/custom.js' %}"></script>
    
    <script>
        // Initialize Bootstrap tooltips
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // Ensure logo container is visible on page load
            showSection('logo-container');
            
            // Prevent zooming on double tap for mobile
            document.addEventListener('dblclick', function(e) {
                e.preventDefault();
            }, { passive: false });
            
            // Set active navigation item
            function setActiveNavItem(itemId) {
                document.querySelectorAll('.mobile-nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.getElementById(itemId).classList.add('active');
            }
            
            // Show section and hide others
            function showSection(sectionId) {
                // Hide all sections
                const sections = ['logo-container', 'gallery-section', 'about-section', 'camera-section'];
                sections.forEach(section => {
                    const element = document.getElementById(section);
                    if (element) {
                        element.style.display = 'none';
                    }
                });
                
                // Show the selected section
                const selectedSection = document.getElementById(sectionId);
                if (selectedSection) {
                    selectedSection.style.display = 'block';
                }
                
                // Ensure the logo container is completely hidden when showing other sections
                if (sectionId !== 'logo-container') {
                    const logoContainer = document.getElementById('logo-container');
                    if (logoContainer) {
                        logoContainer.style.display = 'none';
                        logoContainer.style.visibility = 'hidden';
                        logoContainer.style.position = 'absolute';
                        logoContainer.style.zIndex = '-1';
                    }
                }
            }
            
            // Camera and image handling functionality
            const logoContainer = document.getElementById('logo-container');
            const gallerySection = document.getElementById('gallery-section');
            const aboutSection = document.getElementById('about-section');
            const cameraSection = document.getElementById('camera-section');
            const cameraPreview = document.getElementById('camera-preview');
            const cameraCanvas = document.getElementById('camera-canvas');
            const captureBtn = document.getElementById('capture-btn');
            const retakeBtn = document.getElementById('retake-btn');
            const cameraImageData = document.getElementById('camera-image-data');
            const previewContainer = document.getElementById('preview-container');
            const previewImage = document.getElementById('preview-image');
            const imageUpload = document.getElementById('image-upload');
            const predictionForm = document.getElementById('prediction-form');
            const loadingSpinner = document.getElementById('loading-spinner');
            const submitBtn = document.getElementById('submit-btn');
            const submitContainer = document.getElementById('submit-container');
            
            let stream = null;
            let hasCapture = false;
            
            // Camera button click handler
            const cameraBtn = document.getElementById('camera-btn');
            if (cameraBtn) {
                cameraBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    if (gallerySection) {
                        // Show gallery section (which contains the camera area)
                        showSection('gallery-section');
                        
                        // Show camera section
                        document.getElementById('camera-section').style.display = 'block';
                        previewContainer.style.display = 'none';
                        
                        // Start camera
                        startCamera();
                    } else {
                        // Navigate to home page if we're not already there
                        window.location.href = "{% url 'home' %}#camera-section";
                    }
                    
                    // Update active state
                    setActiveNavItem('camera-btn');
                });
            }
            
            // Gallery button click handler
            const galleryBtn = document.getElementById('gallery-btn');
            if (galleryBtn) {
                galleryBtn.addEventListener('click', function(e) {
                    // If we're not on the home page, let the default navigation happen
                    if (window.location.pathname !== '/') {
                        return;
                    }
                    
                    e.preventDefault();
                    
                    // Don't show gallery section yet - wait for image selection
                    // Instead, just trigger file input click
                    const fileInput = document.getElementById('image-upload');
                    if (fileInput) {
                        fileInput.click();
                    }
                    
                    // Update active state
                    setActiveNavItem('gallery-btn');
                });
            }
            
            // About button click handler
            const aboutBtn = document.getElementById('about-btn');
            if (aboutBtn) {
                aboutBtn.addEventListener('click', function(e) {
                    // If we're not on the home page, let the default navigation happen
                    if (window.location.pathname !== '/') {
                        return;
                    }
                    
                    e.preventDefault();
                    
                    // Show about section
                    showSection('about-section');
                    
                    // Update active state
                    setActiveNavItem('about-btn');
                });
            }
            
            // Image upload change handler
            if (imageUpload) {
                imageUpload.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            // Show gallery section
                            showSection('gallery-section');
                            
                            // Hide camera section, show preview
                            if (cameraSection) cameraSection.style.display = 'none';
                            previewImage.src = e.target.result;
                            previewContainer.style.display = 'block';
                            submitContainer.style.display = 'block';
                            
                            // Reset camera data
                            cameraImageData.value = '';
                            hasCapture = false;
                            
                            // Update active state
                            setActiveNavItem('gallery-btn');
                        };
                        
                        reader.readAsDataURL(this.files[0]);
                    } else {
                        // User canceled file selection
                        // Keep showing the logo container
                        showSection('logo-container');
                    }
                });
            }
            
            // Start camera
            function startCamera() {
                if (!cameraPreview) return;
                
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        } 
                    })
                    .then(function(mediaStream) {
                        stream = mediaStream;
                        cameraPreview.srcObject = mediaStream;
                        cameraPreview.style.display = 'block';
                        cameraCanvas.style.display = 'none';
                        captureBtn.style.display = 'inline-block';
                        retakeBtn.style.display = 'none';
                        submitContainer.style.display = 'none';
                        cameraPreview.play();
                    })
                    .catch(function(error) {
                        console.error('Error accessing camera:', error);
                        alert('Unable to access camera. Please check permissions or try uploading an image instead.');
                    });
                } else {
                    alert('Your browser does not support camera access. Please try uploading an image instead.');
                }
            }
            
            // Stop camera
            function stopCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                if (cameraPreview) cameraPreview.style.display = 'none';
            }
            
            // Capture photo
            if (captureBtn) {
                captureBtn.addEventListener('click', function() {
                    if (stream) {
                        const context = cameraCanvas.getContext('2d');
                        
                        // Set canvas dimensions to match video
                        cameraCanvas.width = cameraPreview.videoWidth;
                        cameraCanvas.height = cameraPreview.videoHeight;
                        
                        // Draw video frame to canvas
                        context.drawImage(cameraPreview, 0, 0, cameraCanvas.width, cameraCanvas.height);
                        
                        // Convert canvas to data URL
                        const imageData = cameraCanvas.toDataURL('image/jpeg', 0.9);
                        cameraImageData.value = imageData;
                        
                        // Show canvas with captured image
                        cameraPreview.style.display = 'none';
                        cameraCanvas.style.display = 'block';
                        captureBtn.style.display = 'none';
                        retakeBtn.style.display = 'inline-block';
                        submitContainer.style.display = 'block';
                        
                        hasCapture = true;
                    }
                });
            }
            
            // Retake photo
            if (retakeBtn) {
                retakeBtn.addEventListener('click', function() {
                    cameraPreview.style.display = 'block';
                    cameraCanvas.style.display = 'none';
                    captureBtn.style.display = 'inline-block';
                    retakeBtn.style.display = 'none';
                    submitContainer.style.display = 'none';
                    cameraImageData.value = '';
                    hasCapture = false;
                });
            }
            
            // Form submission
            if (predictionForm) {
                predictionForm.addEventListener('submit', function(e) {
                    // Check if we have either a file upload or camera capture
                    if (!imageUpload.files.length && !hasCapture) {
                        e.preventDefault();
                        alert('Please upload an image or take a photo first.');
                        return false;
                    }
                    
                    // Show loading spinner
                    loadingSpinner.style.display = 'block';
                    submitBtn.disabled = true;
                    
                    // If using camera, we need to stop it
                    stopCamera();
                    
                    return true;
                });
            }
        });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>

<!-- Image Zoom Modal -->
<div class="modal fade" id="imageZoomModal" tabindex="-1" aria-labelledby="imageZoomModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imageZoomModalLabel">Image Detail</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="zoomedImage" class="img-fluid" alt="Zoomed Image">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

</html>